generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============
enum Role {
  SUPER_ADMIN
  REGISTRAR
  TEACHER
  STUDENT
}

enum Gender {
  MALE
  FEMALE
}

enum StudentStatus {
  APPLICANT
  ADMITTED
  ENROLLED
  NOT_ENROLLED
  GRADUATED
  DROPPED
}

enum CourseType {
  RECORDED
  LIVE
}

enum SessionType {
  CLASS
  EXAM
}

enum ExamAttemptStatus {
  IN_PROGRESS
  SUBMITTED
  TIMED_OUT
  FLAGGED
}

enum PriceType {
  ONE_TIME
  MONTHLY
  YEARLY
}

enum ProgramType {
  WEBINAR
  IN_PERSON
  ONLINE
  EVENT
  HYBRID
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum NotificationType {
  CLASS_5HR
  CLASS_2HR
  CLASS_10MIN
  CLASS_LIVE
  EXAM_REMINDER
  MATERIAL_ADDED
}

// ============ MODELS ============

// User - for authentication
model User {
  id                String   @id @default(cuid())
  userId            String   @unique // ADMIN-001, STU-20250001, etc.
  email             String?  @unique
  password          String
  role              Role
  mustChangePassword Boolean @default(true)
  profileComplete   Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  profile  Profile?
  student  Student?
  teacher  Teacher?
  registrar Registrar?
  programEnrollments ProgramEnrollment[]
  notifications Notification[]
  coursesCreated Course[] @relation("CoursesCreated")
}

// Profile - personal information
model Profile {
  id         String   @id @default(cuid())
  userId     String   @unique
  firstName  String
  lastName   String
  middleName String?
  gender     Gender?
  birthDate  DateTime?
  phone      String?
  address    String?
  avatar     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Student record
model Student {
  id         String        @id @default(cuid())
  userId     String        @unique
  studentId  String        @unique // STU-20250001
  status     StudentStatus @default(APPLICANT)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments  Enrollment[]
  notes        StudentNote[]       // Personal notes for scheduled sessions
  attendance   SessionAttendance[] // Attendance records for sessions
  examScores   ExamScore[]         // Exam scores for grading
  examAttempts ExamAttempt[]       // Exam attempts
  gradeCalculations GradeCalculation[] // Calculated grades
  
  // Program relations
  programAttendance    ProgramAttendance[]    // Attendance for program sessions
  programExamAttempts  ProgramExamAttempt[]   // Program exam attempts
  programNotes         ProgramStudentNote[]   // Notes for program content
}

// Teacher record
model Teacher {
  id         String   @id @default(cuid())
  userId     String   @unique
  teacherId  String   @unique // TEA-20250001
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  courses  Course[]
  programs Program[]
}

// Registrar record
model Registrar {
  id          String   @id @default(cuid())
  userId      String   @unique
  registrarId String   @unique // REG-20250001
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ID Sequence tracker
model IdSequence {
  id        String   @id @default(cuid())
  type      String   // STUDENT, TEACHER, REGISTRAR
  year      Int
  lastNumber Int     @default(0)
  
  @@unique([type, year])
}

// ============ PROGRAM MODELS ============

// Program - created by admin (initiatives like webinars, events, classes)
model Program {
  id            String      @id @default(cuid())
  slug          String      @unique @default(cuid()) // URL-friendly identifier
  name          String
  description   String?
  price         Float       @default(0)
  priceType     PriceType   @default(ONE_TIME)
  programType   ProgramType @default(ONLINE)
  schedule      String?     // e.g., "Every Tuesday, 7:00 PM" or "March 15, 2025"
  location      String?     // Address for in-person programs
  meetingLink   String?     // Zoom/Meet link for webinars
  image         String?     // URL for card image
  isActive      Boolean     @default(true)
  startDate     DateTime?   // When the program begins
  endDate       DateTime?   // When the program ends (auto-deactivate after this)
  enrollmentEnd DateTime?   // When enrollment closes
  teacherId     String?     // Assigned teacher
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  teacher     Teacher?    @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  courses     Course[]
  enrollments ProgramEnrollment[]
  modules     ProgramModule[]
  sessions    ProgramSession[]
  exams       ProgramExam[]
  gradeCalculations GradeCalculation[]
}

// ProgramModule - sections within a program (like Module for Course)
model ProgramModule {
  id        String   @id @default(cuid())
  name      String
  order     Int      @default(0)
  programId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  program Program         @relation(fields: [programId], references: [id], onDelete: Cascade)
  lessons ProgramLesson[]
}

// ProgramLesson - content within a module (like Lesson for Course)
model ProgramLesson {
  id          String   @id @default(cuid())
  name        String
  description String?
  materials   String?  // Google Drive links
  videoUrl    String?  // YouTube link for recorded content
  order       Int      @default(0)
  moduleId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  module       ProgramModule          @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  sessions     ProgramSession[]       // Sessions that use this lesson
  studentNotes ProgramStudentNote[]   // Student notes for this lesson
}

// ProgramSession - scheduled sessions for LIVE programs (like ScheduledSession)
model ProgramSession {
  id          String      @id @default(cuid())
  programId   String
  lessonId    String?     // Optional - for CLASS type sessions
  examId      String?     // Optional - for EXAM type sessions
  date        DateTime
  startTime   String      // e.g., "19:00"
  endTime     String      // e.g., "21:00"
  type        SessionType @default(CLASS)
  meetingLink String?     // Zoom/Meet link
  notes       String?     // Admin notes visible to students
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  program      Program                  @relation(fields: [programId], references: [id], onDelete: Cascade)
  lesson       ProgramLesson?           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  exam         ProgramExam?             @relation(fields: [examId], references: [id], onDelete: Cascade)
  materials    ProgramSessionMaterial[]
  studentNotes ProgramStudentNote[]
  attendance   ProgramAttendance[]
  examAttempts ProgramExamAttempt[]
}

// ProgramSessionMaterial - materials for a specific session
model ProgramSessionMaterial {
  id        String   @id @default(cuid())
  sessionId String
  name      String
  driveUrl  String
  createdAt DateTime @default(now())

  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// ProgramAttendance - tracks student attendance for program sessions
model ProgramAttendance {
  id        String           @id @default(cuid())
  sessionId String
  studentId String
  status    AttendanceStatus @default(PRESENT)
  joinedAt  DateTime?
  markedBy  String           @default("AUTO")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
}

// ProgramExam - exam for a program (like Exam for Course)
model ProgramExam {
  id          String   @id @default(cuid())
  programId   String
  title       String
  description String?
  totalPoints Int      @default(100)
  order       Int      @default(0)
  timeLimit   Int?     // Minutes
  maxTabSwitch Int     @default(3)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  program   Program                @relation(fields: [programId], references: [id], onDelete: Cascade)
  questions ProgramExamQuestion[]
  attempts  ProgramExamAttempt[]
  sessions  ProgramSession[]
}

// ProgramExamQuestion - question in a program exam
model ProgramExamQuestion {
  id       String @id @default(cuid())
  examId   String
  question String
  points   Int    @default(10)
  order    Int    @default(0)

  exam    ProgramExam             @relation(fields: [examId], references: [id], onDelete: Cascade)
  choices ProgramExamChoice[]
  answers ProgramExamAnswer[]
}

// ProgramExamChoice - answer choice for a program exam question
model ProgramExamChoice {
  id         String  @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean @default(false)
  order      Int     @default(0)

  question ProgramExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers  ProgramExamAnswer[]
}

// ProgramExamAttempt - student's attempt at a program exam
model ProgramExamAttempt {
  id             String            @id @default(cuid())
  examId         String
  studentId      String
  sessionId      String?
  attemptNumber  Int               @default(1)
  startedAt      DateTime          @default(now())
  submittedAt    DateTime?
  tabSwitchCount Int               @default(0)
  status         ExamAttemptStatus @default(IN_PROGRESS)
  score          Float?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  exam    ProgramExam      @relation(fields: [examId], references: [id], onDelete: Cascade)
  student Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  session ProgramSession?  @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  answers ProgramExamAnswer[]

  @@unique([examId, studentId, sessionId])
}

// ProgramExamAnswer - student's answer to a program exam question
model ProgramExamAnswer {
  id         String  @id @default(cuid())
  attemptId  String
  questionId String
  choiceId   String?
  isCorrect  Boolean @default(false)

  attempt  ProgramExamAttempt   @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question ProgramExamQuestion  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  choice   ProgramExamChoice?   @relation(fields: [choiceId], references: [id], onDelete: SetNull)

  @@unique([attemptId, questionId])
}

// ProgramStudentNote - student notes for program sessions/lessons
model ProgramStudentNote {
  id        String   @id @default(cuid())
  content   String
  studentId String
  sessionId String?  // For LIVE programs
  lessonId  String?  // For RECORDED content
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  session ProgramSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  lesson  ProgramLesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([studentId, sessionId])
  @@unique([studentId, lessonId])
}

// Program Enrollment - student enrolls in a program
model ProgramEnrollment {
  id          String   @id @default(cuid())
  studentId   String
  programId   String
  enrolledAt  DateTime @default(now())
  status      EnrollmentStatus @default(ACTIVE)
  
  student     User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  program     Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, programId])
}

// ============ COURSE MODELS ============

// Course - created by teacher or admin
model Course {
  id              String     @id @default(cuid())
  slug            String     @unique  // URL-friendly identifier (e.g., "basic-fiqh-101")
  name            String
  description     String?
  type            CourseType @default(RECORDED)
  isActive        Boolean    @default(false)
  price           Float      @default(0)      // For future use - course pricing
  priceType       PriceType  @default(ONE_TIME) // For future use - ONE_TIME, MONTHLY, YEARLY
  startDate       DateTime?  // When the course begins
  endDate         DateTime?  // When the course ends (auto-deactivate after this)
  enrollmentStart DateTime?  // When enrollment opens (default: immediately)
  enrollmentEnd   DateTime?  // When enrollment closes
  teacherId       String
  programId       String?
  createdById     String?    // Who created this course (admin or teacher's user)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  teacher     Teacher         @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  program     Program?        @relation(fields: [programId], references: [id], onDelete: SetNull)
  createdBy   User?           @relation("CoursesCreated", fields: [createdById], references: [id], onDelete: SetNull)
  modules     Module[]
  enrollments Enrollment[]
  sessions    ScheduledSession[]
  exams       Exam[]
  gradeCalculations GradeCalculation[]
}

// ScheduledSession - class/exam attached to calendar for LIVE courses
model ScheduledSession {
  id          String      @id @default(cuid())
  courseId    String
  lessonId    String?     // Optional - for CLASS type sessions
  examId      String?     // Optional - for EXAM type sessions
  date        DateTime
  startTime   String      // e.g., "19:00" or "7:00 PM"
  endTime     String      // e.g., "21:00" or "9:00 PM" - Required for link visibility
  type        SessionType @default(CLASS)
  meetingLink String?     // Zoom/Meet link for this session
  notes       String?     // Teacher notes visible to students
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  course       Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson       Lesson?             @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  exam         Exam?               @relation(fields: [examId], references: [id], onDelete: Cascade)
  materials    SessionMaterial[]
  studentNotes StudentNote[]
  attendance   SessionAttendance[]
  examAttempts ExamAttempt[]       // Exam attempts for this session
}

// SessionMaterial - date-specific materials attached to a scheduled session
model SessionMaterial {
  id        String   @id @default(cuid())
  sessionId String
  name      String   // e.g., "Dec 9 Worksheet.pdf"
  driveUrl  String   // Google Drive link
  createdAt DateTime @default(now())

  session ScheduledSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// SessionAttendance - tracks student attendance for each session
model SessionAttendance {
  id        String           @id @default(cuid())
  sessionId String
  studentId String
  status    AttendanceStatus @default(PRESENT)
  joinedAt  DateTime?        // When student clicked join link (for auto-mark)
  markedBy  String           @default("AUTO") // "AUTO" or "TEACHER"
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  session ScheduledSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

// Module - sections within a course
model Module {
  id        String   @id @default(cuid())
  name      String
  order     Int      @default(0)
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]
}

// Lesson - class template (content only, no schedule)
model Lesson {
  id          String    @id @default(cuid())
  name        String
  description String?
  materials   String?   // General materials - Google Drive links (reusable across all scheduled dates)
  videoUrl    String?   // For RECORDED courses - YouTube link
  order       Int       @default(0)
  moduleId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  module       Module             @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  sessions     ScheduledSession[] // Sessions that use this lesson as template
  studentNotes StudentNote[]      // Student notes for this lesson (RECORDED courses)
}

// Enrollment - student enrolled in a course
model Enrollment {
  id        String   @id @default(cuid())
  studentId String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
}

// ============ NOTIFICATION MODELS ============

// Notification - for student reminders
model Notification {
  id           String           @id @default(cuid())
  userId       String
  type         NotificationType
  title        String
  message      String
  courseId     String?
  sessionId    String?
  isRead       Boolean          @default(false)
  scheduledFor DateTime         // When to show the notification
  createdAt    DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============ EXAM MODELS ============

// Exam - exam template (like Lesson, but for grading)
model Exam {
  id            String   @id @default(cuid())
  courseId      String
  title         String   // e.g., "Quiz 1", "Midterm", "Final Exam"
  description   String?
  totalPoints   Int      @default(100) // Maximum points (auto-calculated from questions)
  order         Int      @default(0)
  timeLimit     Int?     // Time limit in minutes (null = no limit)
  maxTabSwitch  Int      @default(3)  // Max allowed tab switches before flagged
  isPublished   Boolean  @default(false) // Only published exams visible to students
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  course    Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  scores    ExamScore[]
  questions ExamQuestion[]
  attempts  ExamAttempt[]
  sessions  ScheduledSession[]
}

// ExamScore - student's final score for an exam (auto-calculated from attempt)
model ExamScore {
  id        String   @id @default(cuid())
  examId    String
  studentId String
  score     Float    // Points earned (e.g., 85 out of 100)
  gradedAt  DateTime @default(now())
  notes     String?  // Teacher notes for this score
  updatedAt DateTime @updatedAt

  exam    Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([examId, studentId]) // One score per student per exam
}

// ExamQuestion - individual question in an exam
model ExamQuestion {
  id       String @id @default(cuid())
  examId   String
  question String // The question text
  points   Int    @default(10) // Points for this question
  order    Int    @default(0)

  exam    Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  choices ExamChoice[]
  answers ExamAnswer[]
}

// ExamChoice - answer choice for a question (multiple choice)
model ExamChoice {
  id         String  @id @default(cuid())
  questionId String
  text       String  // Choice text (e.g., "A) Shahada")
  isCorrect  Boolean @default(false) // Is this the correct answer?
  order      Int     @default(0)

  question ExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers  ExamAnswer[]
}

// ExamAttempt - student's attempt at taking an exam
model ExamAttempt {
  id             String            @id @default(cuid())
  examId         String
  studentId      String
  sessionId      String?           // Links to scheduled session (for retake tracking)
  attemptNumber  Int               @default(1) // Which attempt this is (1, 2, 3...)
  startedAt      DateTime          @default(now())
  submittedAt    DateTime?
  tabSwitchCount Int               @default(0) // Track tab/window switches
  status         ExamAttemptStatus @default(IN_PROGRESS)
  score          Float?            // Final score (calculated on submit)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  exam    Exam              @relation(fields: [examId], references: [id], onDelete: Cascade)
  student Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  session ScheduledSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  answers ExamAnswer[]

  @@unique([examId, studentId, sessionId]) // One attempt per student per exam per session
}

// ExamAnswer - student's answer to a question
model ExamAnswer {
  id         String  @id @default(cuid())
  attemptId  String
  questionId String
  choiceId   String? // Selected choice (null if not answered)
  isCorrect  Boolean @default(false) // Was the answer correct?

  attempt  ExamAttempt   @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question ExamQuestion  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  choice   ExamChoice?   @relation(fields: [choiceId], references: [id], onDelete: SetNull)

  @@unique([attemptId, questionId]) // One answer per question per attempt
}

// ============ STUDENT NOTES ============

// StudentNote - personal notes by students for sessions (LIVE) or lessons (RECORDED)
model StudentNote {
  id        String   @id @default(cuid())
  content   String   // The note text
  studentId String
  sessionId String?  // For LIVE courses - links to scheduled session
  lessonId  String?  // For RECORDED courses - links to lesson
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  session ScheduledSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  lesson  Lesson?           @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([studentId, sessionId]) // One note per student per session
  @@unique([studentId, lessonId])  // One note per student per lesson
}

// ============ GRADES ============

// GradeCalculation - Calculated grades for students
model GradeCalculation {
  id              String   @id @default(cuid())
  studentId       String
  courseId        String?
  programId       String?
  examScore       Float    // Average exam score (0-100)
  attendanceScore Float    // Attendance percentage (0-100)
  finalGrade      Float    // Weighted final grade (0-100)
  letterGrade     String   // A, B+, B, C+, C, D, F
  gpa             Float    // 4.0 scale
  calculatedAt    DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  student Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course?  @relation(fields: [courseId], references: [id], onDelete: SetNull)
  program Program? @relation(fields: [programId], references: [id], onDelete: SetNull)
  
  @@unique([studentId, courseId])
  @@unique([studentId, programId])
}
