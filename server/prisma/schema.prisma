generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============
enum Role {
  SUPER_ADMIN
  REGISTRAR
  TEACHER
  STUDENT
}

enum Gender {
  MALE
  FEMALE
}

enum StudentStatus {
  APPLICANT
  ADMITTED
  ENROLLED
  NOT_ENROLLED
  GRADUATED
  DROPPED
}

enum CourseType {
  RECORDED
  LIVE
}

enum SessionType {
  CLASS
  EXAM
}

enum PriceType {
  ONE_TIME
  MONTHLY
  YEARLY
}

enum ProgramType {
  WEBINAR
  IN_PERSON
  ONLINE
  EVENT
  HYBRID
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum NotificationType {
  CLASS_5HR
  CLASS_2HR
  CLASS_10MIN
  CLASS_LIVE
  EXAM_REMINDER
  MATERIAL_ADDED
}

// ============ MODELS ============

// User - for authentication
model User {
  id                String   @id @default(cuid())
  userId            String   @unique // ADMIN-001, STU-20250001, etc.
  email             String?  @unique
  password          String
  role              Role
  mustChangePassword Boolean @default(true)
  profileComplete   Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  profile  Profile?
  student  Student?
  teacher  Teacher?
  registrar Registrar?
  programEnrollments ProgramEnrollment[]
  notifications Notification[]
}

// Profile - personal information
model Profile {
  id         String   @id @default(cuid())
  userId     String   @unique
  firstName  String
  lastName   String
  middleName String?
  gender     Gender?
  birthDate  DateTime?
  phone      String?
  address    String?
  avatar     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Student record
model Student {
  id         String        @id @default(cuid())
  userId     String        @unique
  studentId  String        @unique // STU-20250001
  status     StudentStatus @default(APPLICANT)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]
  notes       StudentNote[] // Personal notes for scheduled sessions
}

// Teacher record
model Teacher {
  id         String   @id @default(cuid())
  userId     String   @unique
  teacherId  String   @unique // TEA-20250001
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courses Course[]
}

// Registrar record
model Registrar {
  id          String   @id @default(cuid())
  userId      String   @unique
  registrarId String   @unique // REG-20250001
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ID Sequence tracker
model IdSequence {
  id        String   @id @default(cuid())
  type      String   // STUDENT, TEACHER, REGISTRAR
  year      Int
  lastNumber Int     @default(0)
  
  @@unique([type, year])
}

// ============ PROGRAM MODELS ============

// Program - created by admin (initiatives like webinars, events, classes)
model Program {
  id          String      @id @default(cuid())
  name        String
  description String?
  price       Float       @default(0)
  priceType   PriceType   @default(ONE_TIME)
  programType ProgramType @default(ONLINE)
  schedule    String?     // e.g., "Every Tuesday, 7:00 PM" or "March 15, 2025"
  location    String?     // Address for in-person programs
  meetingLink String?     // Zoom/Meet link for webinars
  image       String?     // URL for card image
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  courses     Course[]
  enrollments ProgramEnrollment[]
}

// Program Enrollment - student enrolls in a program
model ProgramEnrollment {
  id          String   @id @default(cuid())
  studentId   String
  programId   String
  enrolledAt  DateTime @default(now())
  status      EnrollmentStatus @default(ACTIVE)
  
  student     User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  program     Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, programId])
}

// ============ COURSE MODELS ============

// Course - created by teacher
model Course {
  id              String     @id @default(cuid())
  name            String
  description     String?
  type            CourseType @default(RECORDED)
  isActive        Boolean    @default(false)
  startDate       DateTime?  // When the course begins
  endDate         DateTime?  // When the course ends (auto-deactivate after this)
  enrollmentStart DateTime?  // When enrollment opens (default: immediately)
  enrollmentEnd   DateTime?  // When enrollment closes
  teacherId       String
  programId       String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  teacher     Teacher         @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  program     Program?        @relation(fields: [programId], references: [id], onDelete: SetNull)
  modules     Module[]
  enrollments Enrollment[]
  sessions    ScheduledSession[]
}

// ScheduledSession - class/exam attached to calendar for LIVE courses
model ScheduledSession {
  id          String      @id @default(cuid())
  courseId    String
  lessonId    String      // Required - must link to class template
  date        DateTime
  startTime   String      // e.g., "19:00" or "7:00 PM"
  endTime     String      // e.g., "21:00" or "9:00 PM" - Required for link visibility
  type        SessionType @default(CLASS)
  meetingLink String?     // Zoom/Meet link for this session
  notes       String?     // Teacher notes visible to students
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  course       Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson       Lesson            @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  materials    SessionMaterial[]
  studentNotes StudentNote[]
}

// SessionMaterial - date-specific materials attached to a scheduled session
model SessionMaterial {
  id        String   @id @default(cuid())
  sessionId String
  name      String   // e.g., "Dec 9 Worksheet.pdf"
  driveUrl  String   // Google Drive link
  createdAt DateTime @default(now())

  session ScheduledSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// Module - sections within a course
model Module {
  id        String   @id @default(cuid())
  name      String
  order     Int      @default(0)
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]
}

// Lesson - class template (content only, no schedule)
model Lesson {
  id          String    @id @default(cuid())
  name        String
  description String?
  materials   String?   // General materials - Google Drive links (reusable across all scheduled dates)
  videoUrl    String?   // For RECORDED courses - YouTube link
  order       Int       @default(0)
  moduleId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  module   Module             @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  sessions ScheduledSession[] // Sessions that use this lesson as template
}

// Enrollment - student enrolled in a course
model Enrollment {
  id        String   @id @default(cuid())
  studentId String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
}

// ============ NOTIFICATION MODELS ============

// Notification - for student reminders
model Notification {
  id           String           @id @default(cuid())
  userId       String
  type         NotificationType
  title        String
  message      String
  courseId     String?
  sessionId    String?
  isRead       Boolean          @default(false)
  scheduledFor DateTime         // When to show the notification
  createdAt    DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============ STUDENT NOTES ============

// StudentNote - personal notes by students for each scheduled session
model StudentNote {
  id        String   @id @default(cuid())
  content   String   // The note text
  studentId String
  sessionId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  session ScheduledSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([studentId, sessionId]) // One note per student per session
}
